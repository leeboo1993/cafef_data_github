# ============================================================
# üìÖ DAILY VCB FX, USD Black Market & Trading Account Updater
# ============================================================
name: Daily VCB FX + USD Black Market + Trading Account Update

# ============================================================
# ‚öôÔ∏è Schedule + Manual Run
# ============================================================
on:
  schedule:
    # Run daily at 13:00 UTC = 20:00 Vietnam time (GMT+7)
    - cron: "0 13 * * *"
  workflow_dispatch:

# ============================================================
# üíª MAIN JOB
# ============================================================
jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # --------------------------------------------------------
      # 1Ô∏è‚É£ Checkout code
      # --------------------------------------------------------
      - name: üß≠ Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # 2Ô∏è‚É£ Setup Python 3.11
      # --------------------------------------------------------
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # --------------------------------------------------------
      # 3Ô∏è‚É£ Install dependencies
      # --------------------------------------------------------
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas pyarrow boto3 playwright beautifulsoup4 requests
          playwright install firefox chromium

      # --------------------------------------------------------
      # 4Ô∏è‚É£ Run VCB FX Data Scraper (T-5 to today)
      # --------------------------------------------------------
      - name: üí± Run VCB FX data scraper
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running VCB FX scraper (T-5 to today)..."
          python vcb_fx_data.py

      # --------------------------------------------------------
      # 5Ô∏è‚É£ Run USD Black Market Scraper (T-5 to today)
      # --------------------------------------------------------
      - name: üíµ Run USD Black Market scraper
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running USD Black Market scraper (T-5 to today)..."
          python usd_black_market.py

      # --------------------------------------------------------
      # 6Ô∏è‚É£ Run Trading Account Scraper (last 6 months)
      # --------------------------------------------------------
      - name: üìä Run Trading Account scraper
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running Trading Account scraper (last 6 months)..."
          python trading_account.py

      # --------------------------------------------------------
      # 7Ô∏è‚É£ Commit and push changes
      # --------------------------------------------------------
      - name: üíæ Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add vcb_fx_data/vcb_fx_data.csv usd_black_market/usd_market_data.csv stock_trading_account/stock_trading_account.csv
          git diff --staged --quiet || git commit -m "ü§ñ Auto-update: VCB FX, USD Black Market & Trading Account data ($(date +'%Y-%m-%d'))"
          git push

      # --------------------------------------------------------
      # 8Ô∏è‚É£ Final confirmation log
      # --------------------------------------------------------
      - name: ‚úÖ Summary
        run: |
          echo "üéØ All data updated successfully:"
          echo "  - VCB FX data      ‚Üí vcb_fx_data/ + R2"
          echo "  - USD Black Market ‚Üí usd_black_market/ + R2"
          echo "  - Trading Account  ‚Üí stock_trading_account/ + R2"
