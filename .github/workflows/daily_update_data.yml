# ============================================================
# üìÖ DAILY DATA UPDATER - ALL SOURCES
# ============================================================
name: Daily Update Data

# ============================================================
# ‚öôÔ∏è Schedule + Manual Run
# ============================================================
on:
  push:
    branches: [main]
  schedule:
    # Run daily at 15:00 UTC = 22:00 Vietnam time (GMT+7)
    - cron: "0 15 * * *"
  workflow_dispatch:

permissions:
  contents: write

# ============================================================
# üíª MAIN JOB
# ============================================================
jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # --------------------------------------------------------
      # 1Ô∏è‚É£ Checkout code
      # --------------------------------------------------------
      - name: üß≠ Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # 2Ô∏è‚É£ Setup Python 3.11
      # --------------------------------------------------------
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # --------------------------------------------------------
      # 3Ô∏è‚É£ Install dependencies
      # --------------------------------------------------------
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install --with-deps firefox chromium

      # --------------------------------------------------------
      # 4Ô∏è‚É£ Export Cloudflare R2 credentials
      # --------------------------------------------------------
      - name: üîê Setup environment
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "‚úÖ R2 credentials loaded into environment."

      # --------------------------------------------------------
      # 5Ô∏è‚É£ Run Caf√©F Stock Price Downloader
      # --------------------------------------------------------
      - name: üíπ Run Unified CafeF Data Downloader
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running Unified CafeF Data Downloader..."
          python cafef_data_downloader.py

      # --------------------------------------------------------
      # 6Ô∏è‚É£ Run Gold Price Downloader
      # --------------------------------------------------------
      - name: ü™ô Run Gold price updater
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running gold price updater..."
          python gold_price_scraper.py

      # --------------------------------------------------------
      # 7Ô∏è‚É£ Run Vietnamnet Deposit Rate Scraper
      # --------------------------------------------------------
      - name: üè¶ Run Deposit Rate scraper
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running deposit rate scraper (last 3 days)..."
          # Get date 3 days ago in YYYY-MM-DD format
          START_DATE=$(date -d "3 days ago" +%Y-%m-%d 2>/dev/null || date -v-3d +%Y-%m-%d)
          python vietnamnet_interest_rate.py --start_date=$START_DATE

      # --------------------------------------------------------
      # 8Ô∏è‚É£ Run VCB FX Data Scraper (T-5 to today)
      # --------------------------------------------------------
      - name: üí± Run VCB FX data scraper
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running VCB FX scraper (T-5 to today)..."
          python vcb_fx_data.py

      # --------------------------------------------------------
      # 9Ô∏è‚É£ Run USD Black Market Scraper (T-5 to today)
      # --------------------------------------------------------
      - name: üíµ Run USD Black Market scraper
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running USD Black Market scraper (T-5 to today)..."
          python usd_black_market.py

      # --------------------------------------------------------
      # üîü Run Trading Account Scraper (last 6 months)
      # --------------------------------------------------------
      - name: üìä Run Trading Account scraper
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running Trading Account scraper (last 6 months)..."
          python trading_account.py

      # --------------------------------------------------------
      # 1Ô∏è‚É£1Ô∏è‚É£ Run Interbank Rate Scraper
      # --------------------------------------------------------
      - name: üè¶ Run Interbank Rate scraper
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running Interbank Rate scraper..."
          python on_rate_scrape.py

      # --------------------------------------------------------
      # 1Ô∏è‚É£2Ô∏è‚É£ Run Comprehensive Scraper (Prop, Insider, Orders, Ticks)
      # --------------------------------------------------------
      - name: üïµÔ∏è Run Comprehensive Scraper
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running Comprehensive Scraper (T-5 Business Days)..."
          # Run with a 5 business day lookback to ensure gapless data
          python cafef_comprehensive_scraper.py --lookback-days 5 --workers 20

      # --------------------------------------------------------
      # 1Ô∏è‚É£3Ô∏è‚É£ Run Global Market Scraper
      # --------------------------------------------------------
      - name: üåê Run Global Market Scraper
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running Global Market Scraper..."
          python global_market_scraper.py

      # --------------------------------------------------------
      # 1Ô∏è‚É£4Ô∏è‚É£ Run ETF Flow Scraper
      # --------------------------------------------------------
      - name: üìà Run ETF Flow Scraper
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running ETF Flow Scraper..."
          python etf_flow_scraper.py

      # --------------------------------------------------------
      # 1Ô∏è‚É£5Ô∏è‚É£ Run Investor Flow Scraper
      # --------------------------------------------------------
      - name: üíº Run Investor Flow Scraper
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running Investor Flow Scraper..."
          python investor_flow_scraper.py

      # --------------------------------------------------------
      # 1Ô∏è‚É£6Ô∏è‚É£ Run Crypto Scraper
      # --------------------------------------------------------
      - name: ‚Çø Run Crypto Scraper
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running Crypto Scraper..."
          python crypto_scraper.py

      # --------------------------------------------------------
      # 1Ô∏è‚É£7Ô∏è‚É£ Run Bond Market Scraper
      # --------------------------------------------------------
      - name: üìâ Run Bond Market Scraper
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running Bond Market Scraper..."
          python bond_market_scraper.py

      # --------------------------------------------------------
      # 1Ô∏è‚É£8Ô∏è‚É£ Cleanup Stuck Uploads
      # --------------------------------------------------------
      - name: üßπ Cleanup Stuck Multipart Uploads
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Cleaning up interrupted/stuck uploads..."
          python run_cleanup.py

      # --------------------------------------------------------
      # 1Ô∏è‚É£9Ô∏è‚É£ Final confirmation log
      # --------------------------------------------------------
      - name: ‚úÖ Summary
        run: |
          echo "üéØ All data updated successfully and uploaded to R2:"
          echo "  - Stock prices       ‚Üí cafef_data/"
          echo "  - Gold prices        ‚Üí cafef_data/"
          echo "  - Deposit rate       ‚Üí cafef_data/"
          echo "  - VCB FX data        ‚Üí cafef_data/"
          echo "  - USD Black Market   ‚Üí cafef_data/"
          echo "  - Trading Account    ‚Üí cafef_data/"
          echo "  - Interbank Rate     ‚Üí cafef_data/"
          echo "  - Comprehensive      ‚Üí cafef_data/"
          echo "  - Global Markets     ‚Üí cafef_data/global_markets/"
          echo "  - ETF Flows          ‚Üí cafef_data/etf_flows/"
          echo "  - Investor Flows     ‚Üí cafef_data/investor_flows/"
          echo "  - Crypto             ‚Üí cafef_data/alternative_assets/"
          echo "  - Bond Market        ‚Üí cafef_data/bond_market/"