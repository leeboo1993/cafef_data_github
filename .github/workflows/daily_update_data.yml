# ============================================================
# üìÖ DAILY DATA UPDATER - ALL SOURCES
# ============================================================
name: Daily Update Data

# ============================================================
# ‚öôÔ∏è Schedule + Manual Run
# ============================================================
on:
  schedule:
    # Run daily at 13:00 UTC = 20:00 Vietnam time (GMT+7)
    - cron: "0 13 * * *"
  workflow_dispatch:

permissions:
  contents: write

# ============================================================
# üíª MAIN JOB
# ============================================================
jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # --------------------------------------------------------
      # 1Ô∏è‚É£ Checkout code
      # --------------------------------------------------------
      - name: üß≠ Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # 2Ô∏è‚É£ Setup Python 3.11
      # --------------------------------------------------------
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # --------------------------------------------------------
      # 3Ô∏è‚É£ Install dependencies
      # --------------------------------------------------------
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install --with-deps firefox chromium

      # --------------------------------------------------------
      # 4Ô∏è‚É£ Export Cloudflare R2 credentials
      # --------------------------------------------------------
      - name: üîê Setup environment
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "‚úÖ R2 credentials loaded into environment."

      # --------------------------------------------------------
      # 5Ô∏è‚É£ Run Caf√©F Stock Price Downloader
      # --------------------------------------------------------
      - name: üíπ Run Unified CafeF Data Downloader
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running Unified CafeF Data Downloader..."
          python cafef_data_downloader.py

      # --------------------------------------------------------
      # 6Ô∏è‚É£ Run Gold Price Downloader
      # --------------------------------------------------------
      - name: ü™ô Run Gold price updater
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running gold price updater..."
          python gold_price_scraper.py

      # --------------------------------------------------------
      # 7Ô∏è‚É£ Run Vietnamnet Deposit Rate Scraper
      # --------------------------------------------------------
      - name: üè¶ Run Deposit Rate scraper
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running deposit rate scraper (last 3 days)..."
          # Get date 3 days ago in YYYY-MM-DD format
          START_DATE=$(date -d "3 days ago" +%Y-%m-%d 2>/dev/null || date -v-3d +%Y-%m-%d)
          python vietnamnet_interest_rate.py --start_date=$START_DATE

      # --------------------------------------------------------
      # 8Ô∏è‚É£ Run VCB FX Data Scraper (T-5 to today)
      # --------------------------------------------------------
      - name: üí± Run VCB FX data scraper
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running VCB FX scraper (T-5 to today)..."
          python vcb_fx_data.py

      # --------------------------------------------------------
      # 9Ô∏è‚É£ Run USD Black Market Scraper (T-5 to today)
      # --------------------------------------------------------
      - name: üíµ Run USD Black Market scraper
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running USD Black Market scraper (T-5 to today)..."
          python usd_black_market.py

      # --------------------------------------------------------
      # üîü Run Trading Account Scraper (last 6 months)
      # --------------------------------------------------------
      - name: üìä Run Trading Account scraper
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running Trading Account scraper (last 6 months)..."
          python trading_account.py

      # --------------------------------------------------------
      # 1Ô∏è‚É£1Ô∏è‚É£ Run Comprehensive Scraper (Prop, Insider, Orders, Ticks)
      # --------------------------------------------------------
      - name: üïµÔ∏è Run Comprehensive Scraper
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running Comprehensive Scraper (T-5 Business Days)..."
          # Run with a 5 business day lookback to ensure gapless data
          python cafef_comprehensive_scraper.py --lookback-days 5 --workers 20

      # --------------------------------------------------------
      # 1Ô∏è‚É£2Ô∏è‚É£ Commit and push changes
      # --------------------------------------------------------
      - name: üíæ Commit and push CSV changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add vcb_fx_data/vcb_fx_data.csv usd_black_market/usd_market_data.csv stock_trading_account/stock_trading_account.csv
          git diff --staged --quiet || git commit -m "ü§ñ Auto-update: VCB FX, USD & Trading Account data ($(date +'%Y-%m-%d'))"
          git fetch origin main
          git rebase origin/main
          git push origin HEAD:main

      # --------------------------------------------------------
      # 1Ô∏è‚É£2Ô∏è‚É£ Final confirmation log
      # --------------------------------------------------------
      - name: ‚úÖ Summary
        run: |
          echo "üéØ All data updated successfully and uploaded to R2:"
          echo "  - Stock prices      ‚Üí cafef_data/"
          echo "  - Gold prices       ‚Üí cafef_data/"
          echo "  - Deposit rate      ‚Üí cafef_data/"
          echo "  - VCB FX data       ‚Üí cafef_data/ + R2"
          echo "  - USD Black Market  ‚Üí cafef_data/ + R2"
          echo "  - Trading Account   ‚Üí cafef_data/ + R2"