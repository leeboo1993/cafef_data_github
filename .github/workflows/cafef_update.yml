name: Daily CaféF Data Update

on:
  schedule:
    - cron: '0 13 * * *'   # 20:00 Vietnam time (13:00 UTC)
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # allow pushing to the repo

    steps:
      # --------------------------------------------------------
      # 1️⃣ Checkout code
      # --------------------------------------------------------
      - name: 🧭 Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # disable default auth

      # --------------------------------------------------------
      # 2️⃣ Setup Python
      # --------------------------------------------------------
      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # --------------------------------------------------------
      # 3️⃣ Install dependencies
      # --------------------------------------------------------
      - name: 📦 Install dependencies
        run: |
          pip install pandas pyarrow requests

      # --------------------------------------------------------
      # 4️⃣ Run the CaféF updater script
      # --------------------------------------------------------
      - name: 🚀 Run CaféF updater
        run: |
          python cafef_data_stock_price_download.py

      # --------------------------------------------------------
      # 5️⃣ Commit and push updated data
      # --------------------------------------------------------
      - name: 💾 Commit and push updated data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -e  # 🔹 stop if any command fails

          echo "🧠 Starting commit and push sequence..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory $GITHUB_WORKSPACE

          echo "📂 Current working directory: $(pwd)"
          echo "🧩 Repository detected: $REPO"
          echo "--------------------------------------------"

          echo "🧮 Adding and committing changes..."
          git add cafef_price/ || { echo "❌ [ERROR LINE 1] Git add failed"; exit 1; }
          git commit -m "🔁 Auto update CaféF data ($(date +'%Y-%m-%d'))" \
            && echo "✅ Commit success" \
            || echo "ℹ️ No new changes to commit"

          echo "--------------------------------------------"
          echo "🔐 Resetting and verifying remote..."
          git remote -v || { echo "❌ [ERROR LINE 2] Git remote -v failed"; exit 1; }
          git remote remove origin || true
          git remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO}.git"
          git remote -v || { echo "❌ [ERROR LINE 3] Git remote setup failed"; exit 1; }

          echo "--------------------------------------------"
          echo "🚀 Attempting to push..."
          git push origin HEAD:main --force || { 
            echo "❌ [ERROR LINE 4] Git push failed. Likely due to bad credentials or wrong remote."; 
            echo "   → Check if remote is private or token missing permissions."; 
            exit 1; 
          }

          echo "✅ Push completed successfully!"

      # --------------------------------------------------------
      # 6️⃣ Upload parquet artifacts
      # --------------------------------------------------------
      - name: 📤 Upload data artifact
        uses: actions/upload-artifact@v4
        with:
          name: cafef-data
          path: cafef_price/*.parquet