# ============================================================
# üìÖ Daily Caf√©F Data Update to Cloudflare R2
# ============================================================
name: Daily Caf√©F Data Update to R2

# ============================================================
# ‚öôÔ∏è Schedule and manual trigger
# ============================================================
on:
  schedule:
    # 20:00 Vietnam time (13:00 UTC)
    - cron: '0 13 * * *'
  workflow_dispatch:  # allow manual runs

# ============================================================
# üíª Main job
# ============================================================
jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: read   # no push needed anymore (we upload to R2)

    steps:
      # --------------------------------------------------------
      # 1Ô∏è‚É£ Checkout repository
      # --------------------------------------------------------
      - name: üß≠ Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # 2Ô∏è‚É£ Setup Python
      # --------------------------------------------------------
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # --------------------------------------------------------
      # 3Ô∏è‚É£ Install dependencies
      # --------------------------------------------------------
      - name: üì¶ Install dependencies
        run: |
          pip install pandas pyarrow boto3 requests

      # --------------------------------------------------------
      # 4Ô∏è‚É£ Run the Caf√©F updater script
      # --------------------------------------------------------
      - name: üöÄ Run Caf√©F updater and upload to R2
        env:
          # These secrets come from your GitHub repo ‚Üí Settings ‚Üí Secrets ‚Üí Actions
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: broker-data
        run: |
          python cafef_data_stock_price_download.py

      # --------------------------------------------------------
      # 5Ô∏è‚É£ Upload artifact (optional backup in GitHub Actions)
      # --------------------------------------------------------
      - name: üì§ Upload local Parquet artifact
        uses: actions/upload-artifact@v4
        with:
          name: cafef-data
          path: cafef_price/*.parquet