# ============================================================
# ğŸ“… DAILY CAFEF & VIETNAMNET DATA UPDATER
# ============================================================
name: Daily CafÃ©F + Gold + Deposit Rate Data Update

# ============================================================
# âš™ï¸ Schedule + Manual Run
# ============================================================
on:
  schedule:
    # Run daily at 13:00 UTC = 20:00 Vietnam time (UTC+7)
    - cron: "0 13 * * *"
  workflow_dispatch:

# ============================================================
# ğŸ’» MAIN JOB
# ============================================================
jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # --------------------------------------------------------
      # 1ï¸âƒ£ Checkout code
      # --------------------------------------------------------
      - name: ğŸ§­ Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # 2ï¸âƒ£ Setup Python 3.11
      # --------------------------------------------------------
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # --------------------------------------------------------
      # 3ï¸âƒ£ Install dependencies
      # --------------------------------------------------------
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas pyarrow boto3 playwright beautifulsoup4 requests
          playwright install chromium

      # --------------------------------------------------------
      # 4ï¸âƒ£ Export Cloudflare R2 credentials
      # --------------------------------------------------------
      - name: ğŸ” Setup environment
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "âœ… R2 credentials loaded into environment."

      # --------------------------------------------------------
      # 5ï¸âƒ£ Run CafÃ©F Stock Price Downloader
      # --------------------------------------------------------
      - name: ğŸ’¹ Run CafÃ©F stock price updater
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "ğŸš€ Running stock price updater..."
          python cafef_data_stock_price_download.py

      # --------------------------------------------------------
      # 6ï¸âƒ£ Run Gold Price Downloader
      # --------------------------------------------------------
      - name: ğŸª™ Run Gold price updater
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "ğŸš€ Running gold price updater..."
          python gold_price_scraper.py

      # --------------------------------------------------------
      # 7ï¸âƒ£ Run Vietnamnet Deposit Rate Scraper
      # --------------------------------------------------------
      - name: ğŸ¦ Run Deposit Rate scraper
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "ğŸš€ Running deposit rate scraper (last 3 days)..."
          # Get date 3 days ago in YYYY-MM-DD format
          START_DATE=$(date -d "3 days ago" +%Y-%m-%d 2>/dev/null || date -v-3d +%Y-%m-%d)
          python vietnamnet_interest_rate.py --start_date=$START_DATE

      # --------------------------------------------------------
      # 8ï¸âƒ£ Final confirmation log
      # --------------------------------------------------------
      - name: âœ… Summary
        run: |
          echo "ğŸ¯ All data updated successfully and uploaded to R2:"
          echo "  - Stock prices â†’ cafef_data/"
          echo "  - Gold prices  â†’ cafef_data/"
          echo "  - Deposit rate â†’ cafef_data/"