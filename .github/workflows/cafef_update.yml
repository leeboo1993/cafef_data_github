name: Daily CafÃ©F Data Update

on:
  schedule:
    - cron: '0 13 * * *'   # 20:00 Vietnam time (13:00 UTC)
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # allow pushing to the repo

    steps:
      # --------------------------------------------------------
      # 1ï¸âƒ£ Checkout code
      # --------------------------------------------------------
      - name: ğŸ§­ Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # disable default auth

      # --------------------------------------------------------
      # 2ï¸âƒ£ Setup Python
      # --------------------------------------------------------
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # --------------------------------------------------------
      # 3ï¸âƒ£ Install dependencies
      # --------------------------------------------------------
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install pandas pyarrow requests

      # --------------------------------------------------------
      # 4ï¸âƒ£ Run the CafÃ©F updater script
      # --------------------------------------------------------
      - name: ğŸš€ Run CafÃ©F updater
        run: |
          python cafef_data_stock_price_download.py

      # --------------------------------------------------------
      # 5ï¸âƒ£ Commit and push updated data
      # --------------------------------------------------------
      - name: ğŸ’¾ Commit and push updated data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -e  # ğŸ”¹ stop if any command fails

          echo "ğŸ§  Starting commit and push sequence..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory $GITHUB_WORKSPACE

          echo "ğŸ“‚ Current working directory: $(pwd)"
          echo "ğŸ§© Repository detected: $REPO"
          echo "--------------------------------------------"

          echo "ğŸ§® Adding and committing changes..."
          git add cafef_price/ || { echo "âŒ [ERROR LINE 1] Git add failed"; exit 1; }
          git commit -m "ğŸ” Auto update CafÃ©F data ($(date +'%Y-%m-%d'))" \
            && echo "âœ… Commit success" \
            || echo "â„¹ï¸ No new changes to commit"

          echo "--------------------------------------------"
          echo "ğŸ” Resetting and verifying remote..."
          git remote -v || { echo "âŒ [ERROR LINE 2] Git remote -v failed"; exit 1; }
          git remote remove origin || true
          git remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO}.git"
          git remote -v || { echo "âŒ [ERROR LINE 3] Git remote setup failed"; exit 1; }

          echo "--------------------------------------------"
          echo "ğŸš€ Attempting to push..."
          git push origin HEAD:main --force || { 
            echo "âŒ [ERROR LINE 4] Git push failed. Likely due to bad credentials or wrong remote."; 
            echo "   â†’ Check if remote is private or token missing permissions."; 
            exit 1; 
          }

          echo "âœ… Push completed successfully!"

      # --------------------------------------------------------
      # 6ï¸âƒ£ Upload parquet artifacts
      # --------------------------------------------------------
      - name: ğŸ“¤ Upload data artifact
        uses: actions/upload-artifact@v4
        with:
          name: cafef-data
          path: cafef_price/*.parquet