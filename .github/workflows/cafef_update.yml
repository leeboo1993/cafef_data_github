# ============================================================
# üìÖ DAILY CAFEF & VIETNAMNET DATA UPDATER
# ============================================================
name: Daily Caf√©F + Gold + Deposit Rate Data Update

# ============================================================
# ‚öôÔ∏è Schedule + Manual Run
# ============================================================
on:
  schedule:
    # Run daily at 13:00 UTC = 20:00 Vietnam time (UTC+7)
    - cron: "0 13 * * *"
  workflow_dispatch:

# ============================================================
# üíª MAIN JOB
# ============================================================
jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # --------------------------------------------------------
      # 1Ô∏è‚É£ Checkout code
      # --------------------------------------------------------
      - name: üß≠ Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # 2Ô∏è‚É£ Setup Python 3.11
      # --------------------------------------------------------
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # --------------------------------------------------------
      # 3Ô∏è‚É£ Install dependencies
      # --------------------------------------------------------
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas pyarrow boto3 playwright beautifulsoup4 requests
          playwright install chromium

      # --------------------------------------------------------
      # 4Ô∏è‚É£ Export Cloudflare R2 credentials
      # --------------------------------------------------------
      - name: üîê Setup environment
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "‚úÖ R2 credentials loaded into environment."

      # --------------------------------------------------------
      # 5Ô∏è‚É£ Run Caf√©F Stock Price Downloader
      # --------------------------------------------------------
      - name: üíπ Run Caf√©F stock price updater
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running stock price updater..."
          python cafef_data_stock_price_download.py

      # --------------------------------------------------------
      # 6Ô∏è‚É£ Run Gold Price Downloader
      # --------------------------------------------------------
      - name: ü™ô Run Gold price updater
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running gold price updater..."
          python gold_price_scraper.py

      # --------------------------------------------------------
      # 7Ô∏è‚É£ Run Vietnamnet Deposit Rate Scraper
      # --------------------------------------------------------
      - name: üè¶ Run Deposit Rate scraper
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "üöÄ Running deposit rate scraper..."
          python vietnamnet_interest_rate.py

      # --------------------------------------------------------
      # 8Ô∏è‚É£ Final confirmation log
      # --------------------------------------------------------
      - name: ‚úÖ Summary
        run: |
          echo "üéØ All data updated successfully and uploaded to R2:"
          echo "  - Stock prices ‚Üí cafef_data/"
          echo "  - Gold prices  ‚Üí cafef_data/"
          echo "  - Deposit rate ‚Üí cafef_data/"